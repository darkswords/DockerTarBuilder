name: Cleanup workflow runs (enhanced)

on:
  workflow_dispatch:        # 手动触发
  schedule:
    - cron: '0 3 * * *'    # 每天 03:00 UTC 自动触发

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      KEEP_LATEST: '0'           # 每个 workflow 保留最新多少个 run（0 表示不保留）
      AGE_DAYS: '30'             # 删除早于多少天的 run（0 表示不按天数过滤）
      KEEP_CONCLUSIONS: ''       # 逗号分隔要保留的结论，例如 "success,failure"（空表示不过滤）
      FILTER_BRANCH: ''          # 只针对某分支，如 'main'（空表示不过滤）
      DRY_RUN: 'false'            # true=仅打印，false=执行删除
      PER_WORKFLOW_MODE: 'true'  # 每个 workflow 单独处理分页
      MAX_RETRIES: '3'           # 删除失败时重试次数
      RETRY_DELAY_MS: '1200'     # 重试间隔（毫秒），指数回退
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Diagnose & Delete workflow runs
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const KEEP_LATEST = parseInt(process.env.KEEP_LATEST || '0', 10);
            const AGE_DAYS = parseInt(process.env.AGE_DAYS || '0', 10);
            const KEEP_CONCLUSIONS = (process.env.KEEP_CONCLUSIONS || '').split(',').map(s => s.trim()).filter(Boolean);
            const FILTER_BRANCH = (process.env.FILTER_BRANCH || '').trim();
            const DRY_RUN = (process.env.DRY_RUN || 'true').toLowerCase() === 'true';
            const MAX_RETRIES = parseInt(process.env.MAX_RETRIES || '3', 10);
            const RETRY_DELAY_MS = parseInt(process.env.RETRY_DELAY_MS || '1200', 10);

            function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

            function isoDaysAgo(days){
              const d = new Date();
              d.setUTCDate(d.getUTCDate() - days);
              return d.toISOString();
            }

            const thresholdISO = AGE_DAYS > 0 ? isoDaysAgo(AGE_DAYS) : null;
            console.log(`Config: KEEP_LATEST=${KEEP_LATEST}, AGE_DAYS=${AGE_DAYS}, KEEP_CONCLUSIONS=[${KEEP_CONCLUSIONS}], FILTER_BRANCH='${FILTER_BRANCH}', DRY_RUN=${DRY_RUN}, MAX_RETRIES=${MAX_RETRIES}`);

            // 获取所有 workflows
            const workflows = await github.paginate(github.rest.actions.listRepoWorkflows, { owner, repo, per_page: 100 });
            console.log(`Workflows total: ${workflows.length}`);

            let totalCandidates = 0;
            let totalDeleted = 0;
            let totalSkipped = 0;

            for (const wf of workflows) {
              const wfId = wf.id;
              console.log(`\n== Workflow: id=${wfId}, name='${wf.name}' ==`);
              // 分页获取 workflow runs
              const runs = await github.paginate(github.rest.actions.listWorkflowRuns, { owner, repo, workflow_id: wfId, per_page: 100 });

              let filtered = runs;
              if (FILTER_BRANCH) filtered = filtered.filter(r => r.head_branch === FILTER_BRANCH);
              filtered.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

              // 标记 KEEP_LATEST
              const kept = new Set();
              if (KEEP_LATEST > 0) {
                for (let i = 0; i < Math.min(KEEP_LATEST, filtered.length); i++) kept.add(filtered[i].id);
              }

              for (const r of filtered) {
                const reasons = [];
                if (kept.has(r.id)) reasons.push('kept_by_KEEP_LATEST');
                if (KEEP_CONCLUSIONS.length > 0 && r.conclusion && KEEP_CONCLUSIONS.includes(r.conclusion)) reasons.push(`kept_by_CONCLUSION(${r.conclusion})`);
                if (thresholdISO && !(r.created_at < thresholdISO)) reasons.push(`too_recent(created_at=${r.created_at})`);
                if (r.status && ['in_progress','queued','waiting'].includes(r.status)) reasons.push(`status=${r.status}`);

                if (reasons.length > 0) {
                  console.log(`[SKIP] run id=${r.id} created_at=${r.created_at} conclusion=${r.conclusion} branch=${r.head_branch} reasons=${reasons.join('|')} url=${r.html_url}`);
                  totalSkipped++;
                  continue;
                }

                totalCandidates++;
                console.log(`[CANDIDATE] run id=${r.id} created_at=${r.created_at} conclusion=${r.conclusion} branch=${r.head_branch} url=${r.html_url}`);

                if (DRY_RUN) continue;

                // 尝试删除
                let attempt = 0;
                let success = false;
                let lastError = null;
                while (attempt < MAX_RETRIES && !success) {
                  attempt++;
                  try {
                    await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: r.id });
                    console.log(`[DELETE-SUCCESS] run id=${r.id} (attempt ${attempt})`);
                    totalDeleted++;
                    success = true;
                  } catch (err) {
                    lastError = err;
                    console.log(`[DELETE-ERROR] run id=${r.id} attempt=${attempt} error=${err}`);
                    await sleep(RETRY_DELAY_MS * Math.pow(2, attempt-1));
                  }
                }

                if (!success) {
                  console.log(`[DELETE-FAILED] run id=${r.id} lastError=${lastError}`);
                }
              }
            }

            console.log(`\nSummary: candidates=${totalCandidates}, deleted=${totalDeleted}, skipped=${totalSkipped}`);
